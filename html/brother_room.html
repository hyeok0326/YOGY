<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Subway Escape: 영혼의 포식자</title>
    <style>
        :root { --main-bg: #0a0a0a; --accent: #700; --selected: #f00; --btn-bg: #1a1a1a; }
        body { margin: 0; background: #000; color: #eee; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        
        #game-screen { position: relative; width: 600px; aspect-ratio: 1/1; background: #222; border: 2px solid #333; border-bottom: none; overflow: hidden; margin-top: 20px; }
        
        .bg-layer { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; transition: opacity 2s ease-in-out; }
        #bg-normal { background-image: url('../assets/background/brother_room.png'); z-index: 1; opacity: 1; }
        #bg-horror { background-image: url('../assets/background/brother_room_horror.png'); z-index: 2; opacity: 0; }

        .horror-active #bg-normal { opacity: 0; }
        .horror-active #bg-horror { opacity: 1; }

        #horror-flash { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(150, 0, 0, 0.6); opacity: 0; z-index: 100; pointer-events: none; 
        }

        .hotspot { position: absolute; z-index: 10; cursor: pointer; }
        #lighter-on-bed { top: 55%; left: 15%; width: 10%; height: 8%;}
        #drawer-area { top: 72%; left: 75%; width: 15%; height: 10%;}
        #closet-area { top: 15%; left: 80%; width: 5%; height: 12%;}
        #talisman-on-wall { top: 30%; left: 21%; width: 40px; height: 70px;}
        #desk-diary { top: 47%; left: 40%; width: 15%; height: 5%;}

        #flashlight { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle 120px at 50% 50%, rgba(255,255,245,0.05) 0%, rgba(0,0,0,0.98) 100%); z-index: 5; pointer-events: none; transition: opacity 1s; }
        
        #blood-splash { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: url('../assets/effect/blood_splatter.png') no-repeat center; 
            background-size: contain; z-index: 500; pointer-events: none; 
            transform-origin: center;
        }
        .blood-active { display: block !important; animation: blood-burst 0.5s ease-out forwards; }

        #message-box { height: 100px; width: 600px; background: #0f0f0f; border: 2px solid #333; padding: 15px; box-sizing: border-box; z-index: 20; }
        #msg-text { font-size: 0.95rem; line-height: 1.6; color: #ccc; }

        #inventory { height: 80px; width: 600px; display: flex; gap: 10px; padding: 5px; background: #050505; border: 2px solid #333; border-top: none; justify-content: center; z-index: 20; }
        .inv-slot { width: 70px; height: 70px; border: 1px solid #333; background: #111; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .inv-slot.selected { border: 2px solid var(--selected); box-shadow: inset 0 0 10px rgba(255,0,0,0.5); }
        .inv-slot img { width: 85%; height: 85%; object-fit: contain; }

        #game-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
        #modal-content { position: relative; width: 80%; height: 70%; background: #fdf5e6; border: 5px solid #8b4513; padding: 30px; box-sizing: border-box; color: #333; line-height: 1.8; }
        #modal-content.horror-diary { background: #200; border-color: #f00; color: #f00; }

        /* 붉게 변하는 비밀 암호 스타일 */
        .secret-code { color: inherit; font-weight: inherit; transition: color 0.5s; }
        .revealed .secret-code { color: #d00; font-weight: bold; text-shadow: 0 0 5px rgba(255,0,0,0.3); }

        #ending-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        #ending-text { color: #f00; font-size: 1.8rem; font-weight: 900; margin-bottom: 40px; text-align: center; }
        .ending-btn-group { display: flex; gap: 20px; }
        .ending-btn { padding: 12px 25px; cursor: pointer; font-family: inherit; font-size: 1rem; background: var(--btn-bg); color: #eee; border: 1px solid #444; transition: all 0.3s; }
        .ending-btn:hover { background: #f00; color: #000; border-color: #f00; box-shadow: 0 0 15px #f00; }

        @keyframes blood-burst { 0% { transform: scale(0); opacity: 0; } 40% { opacity: 1; transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0% { transform: translate(4px, 4px); } 50% { transform: translate(-4px, -4px); } 100% { transform: translate(0, 0); } }
        .shake-impact { animation: shake 0.1s 5; } 
        .loop-shake { animation: shake 0.2s infinite; }
        .ending-shake { animation: shake 0.05s infinite !important; }
        @keyframes flash-anim { 0% { opacity: 0; } 20% { opacity: 1; } 100% { opacity: 0; } }
        .flash-active { animation: flash-anim 1.5s forwards; }
    </style>
</head>
<body onmousemove="moveFlashlight(event)">

<div id="game-screen">
    <div id="bg-normal" class="bg-layer"></div>
    <div id="bg-horror" class="bg-layer"></div>
    <div id="horror-flash"></div>

    <div id="lighter-on-bed" class="hotspot" onclick="pickUpItem('lighter', '라이터')"></div>
    <div id="talisman-on-wall" class="hotspot" onclick="pickUpItem('talisman', '부적')"></div>
    <div id="drawer-area" class="hotspot" onclick="interactDrawer()"></div>
    <div id="closet-area" class="hotspot" onclick="interactCloset()"></div>
    <div id="desk-diary" class="hotspot" onclick="interactDiary()"></div>
    
    <div id="flashlight"></div>
    <div id="blood-splash"></div>

    <div id="game-modal">
        <div id="modal-content">
            <div style="position: absolute; top: 5px; right: 15px; cursor: pointer; font-size: 24px;" onclick="closeModal()">×</div>
            <div id="modal-text"></div>
        </div>
    </div>
</div>

<div id="message-box"><div id="msg-text">방 안을 조사하십시오.</div></div>

<div id="inventory">
    <div id="slot-0" class="inv-slot" onclick="selectSlot(0)"></div>
    <div id="slot-1" class="inv-slot" onclick="selectSlot(2)"></div> <div id="slot-2" class="inv-slot" onclick="selectSlot(1)"></div>
    <div id="slot-3" class="inv-slot" onclick="selectSlot(3)"></div>
</div>

<div id="ending-overlay">
    <div id="ending-text">동생을 죽이는데 성공했다.</div>
    <div class="ending-btn-group">
        <button class="ending-btn" onclick="location.reload()">다시하기</button>
        <button class="ending-btn" onclick="goToMain()">메인으로</button>
    </div>
</div>

<script>
    let inventory = [null, null, null, null];
    let selectedIndices = [];
    let flags = { isHorror: false, talismanBurned: false, codeRevealed: false, itemsPicked: {} };

    function goToMain() {
        if(confirm("메인 화면으로 돌아가시겠습니까?")) {
            window.location.href = 'index.html'; 
        }
    }

    function moveFlashlight(e) {
        if (flags.isHorror) return;
        const screen = document.getElementById('game-screen');
        const rect = screen.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        document.getElementById('flashlight').style.background = `radial-gradient(circle 120px at ${x}% ${y}%, rgba(255,255,245,0.05) 0%, rgba(0,0,0,0.98) 100%)`;
    }

    function pickUpItem(id, name) {
        if (flags.itemsPicked[id]) return;
        const emptyIdx = inventory.indexOf(null);
        if (emptyIdx !== -1) {
            inventory[emptyIdx] = { id, name, img: `../assets/items/${id}.png` };
            flags.itemsPicked[id] = true;
            if (id === 'talisman') document.getElementById('talisman-on-wall').style.display = 'none';
            if (id === 'lighter') document.getElementById('lighter-on-bed').style.display = 'none';
            updateMessage(`${name}(을)를 획득했다.`);
            renderInventory();
        }
    }

    function renderInventory() {
        inventory.forEach((item, i) => {
            const slot = document.getElementById(`slot-${i}`);
            slot.classList.toggle('selected', selectedIndices.includes(i));
            slot.innerHTML = item ? `<img src="${item.img}" onerror="this.style.display='none'; this.parentNode.innerText='${item.name}'">` : "";
        });
    }

    function selectSlot(i) {
        if (!inventory[i]) return;
        if (selectedIndices.includes(i)) selectedIndices = []; 
        else {
            selectedIndices.push(i);
            if (selectedIndices.length === 2) checkCombination();
        }
        renderInventory();
    }

    function checkCombination() {
        const ids = selectedIndices.map(idx => inventory[idx].id);
        if (ids.includes('mirror') && ids.includes('knife') && !flags.isHorror) triggerRitual();
        else if (ids.includes('talisman') && ids.includes('lighter')) {
            if (flags.isHorror) burnTalisman();
            else updateMessage("아직 부적을 사용할 때가 아닌 것 같다.");
        }
        selectedIndices = [];
        renderInventory();
    }

    function triggerRitual() {
        flags.isHorror = true;
        const screen = document.getElementById('game-screen');
        const flash = document.getElementById('horror-flash');
        screen.classList.add('shake-impact', 'horror-active');
        flash.classList.add('flash-active');
        document.getElementById('flashlight').style.opacity = '0';
        setTimeout(() => {
            screen.classList.remove('shake-impact');
            document.getElementById('flashlight').style.display = 'none';
            updateMessage("쨍그랑! 거울이 깨지며 공기가 무겁게 내려앉습니다...");
        }, 1500);
        inventory = inventory.map(item => (item && item.id === 'mirror') ? null : item);
        renderInventory();
    }

    function burnTalisman() {
        inventory = inventory.map(item => (item && item.id === 'talisman') ? null : item);
        flags.talismanBurned = true;
        document.getElementById('game-screen').classList.add('loop-shake');
        updateMessage("부적을 태웠습니다! 무언가 울부짖는 소리가 들립니다!");
        renderInventory();
    }

    function interactDiary() {
        const selected = selectedIndices.length === 1 ? inventory[selectedIndices[0]] : null;
        
        if (flags.isHorror) {
            if (selected && selected.id === 'knife' && flags.talismanBurned) {
                document.getElementById('blood-splash').classList.add('blood-active'); 
                document.getElementById('game-screen').classList.add('ending-shake');
                setTimeout(() => { document.getElementById('ending-overlay').style.display = 'flex'; }, 1200);
                return;
            }
            showModal(`<div style='font-size:1.1rem; line-height:1.2; animation: pulse 0.1s infinite;'>${"그만".repeat(150)}</div>`, true);
        } else {
            const isLighterSelected = (selected && selected.id === 'lighter');
            if (isLighterSelected) flags.codeRevealed = true;

            const diaryHTML = `
                <h3>5월 4일</h3>
                <p class="${flags.codeRevealed ? 'revealed' : ''}">
                    <span class="secret-code">오</span>늘의 
                    <span class="secret-code">일</span>기는 어린이날이라 
                    어린<span class="secret-code">이</span>날이라 어린이대
                    <span class="secret-code">공</span>원에 가기로 했다.. 
                    <br><br>
                    <span style="color:rgba(150,0,0,0.6);">(뒷 내용은 핏자국 때문에 보이지 않는다.)</span>
                </p>
            `;
            showModal(diaryHTML);
        }
    }

    function interactDrawer() { pickUpItem('mirror', '거울'); }
    function interactCloset() { 
        const code = prompt("암호:");
        if (code === "5120") pickUpItem('knife', '의식용 칼');
        else if (code !== null) alert("틀렸다.");
    }

    function showModal(html, isHorror = false) {
        const modal = document.getElementById('game-modal');
        const content = document.getElementById('modal-content');
        document.getElementById('modal-text').innerHTML = html;
        content.className = isHorror ? 'horror-diary' : '';
        modal.style.display = 'flex';
    }
    function closeModal() { document.getElementById('game-modal').style.display = 'none'; }
    function updateMessage(txt) { document.getElementById('msg-text').innerText = txt; }
</script>
</body>
</html>
